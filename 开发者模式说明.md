# NetBox 开发者模式说明

## 🎯 模式概述

NetBox 项目现在支持两种运行模式：

### 📦 生产模式（默认）
- **特点**: 源码编译到镜像内部，高性能，稳定
- **适用**: 部署、测试、演示
- **更新**: 需要重新构建镜像

### 🔧 开发模式  
- **特点**: 源码实时挂载，支持实时修改和编译
- **适用**: 开发、调试、代码修改
- **更新**: 修改源码后重新编译即可

## 🚀 启动方式

### 方法1: 使用 Profile（推荐）

```bash
# 生产模式（默认）
docker-compose up -d

# 开发模式
docker-compose --profile dev up -d
```

### 方法2: 使用环境变量

```bash
# 生产模式
NETBOX_MODE=production docker-compose up -d

# 开发模式
NETBOX_MODE=development docker-compose --profile dev up -d
```

## 🛠️ 开发模式使用流程

### 1. 启动开发环境

```bash
# 启动开发容器
docker-compose --profile dev up -d

# 查看启动信息
docker logs netbox-dev-server
```

### 2. 进入开发容器

```bash
# 进入容器
docker exec -it netbox-dev-server bash

# 您现在在 /workspace 目录，这里挂载了您的源码
pwd  # 输出: /workspace
ls   # 可以看到项目所有文件
```

### 3. 编译项目

```bash
# 在容器内执行
cd /workspace
mkdir -p build && cd build

# 配置和编译
cmake .. -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=OFF
make -j$(nproc)
```

### 4. 运行服务

```bash
# 运行 Echo 服务器
./NetBox ../config/config-echo.yaml

# 或者运行 Redis 服务器（新建终端）
./NetBox ../config/config-redis.yaml
```

### 5. 实时开发

✅ **在宿主机修改源码** → **在容器内重新编译** → **重启服务**

```bash
# 宿主机：修改源码
# 例如修改: src/main.cpp

# 容器内：重新编译
cd /workspace/build
make -j$(nproc)

# 容器内：重启服务
./NetBox ../config/config-echo.yaml
```

## 📂 目录结构

### 开发模式挂载点

```
容器内路径              宿主机路径
/workspace         <->  . (项目根目录)
/app/config        <->  ./config
/app/logs          <->  ./logs  
/app/data          <->  ./data
/workspace/build   <->  Docker Volume (持久化)
```

### 实时同步的文件

- ✅ 所有源码文件 (.cpp, .h)
- ✅ CMakeLists.txt
- ✅ 配置文件
- ✅ 脚本文件

## 🔄 常用操作

### 查看容器状态

```bash
# 查看所有容器
docker-compose ps

# 查看开发容器日志
docker logs -f netbox-dev-server
```

### 重新构建开发环境

```bash
# 停止容器
docker-compose --profile dev down

# 重新构建
docker-compose --profile dev build --no-cache

# 重新启动
docker-compose --profile dev up -d
```

### 清理环境

```bash
# 停止所有服务
docker-compose down

# 清理构建缓存
docker volume rm $(docker volume ls -q | grep build-cache)
```

## 🎯 调试功能

### GDB 调试

```bash
# 在容器内
cd /workspace/build

# 编译调试版本
cmake .. -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=OFF
make -j$(nproc)

# 使用 GDB
gdb ./NetBox
```

### 端口映射

- **6379**: Redis 协议端口
- **8888**: Echo 服务端口  
- **9999**: 预留调试端口

## ⚠️ 注意事项

1. **权限问题**: 开发模式下创建的文件可能属于容器用户，请注意文件权限
2. **性能**: 开发模式性能可能低于生产模式
3. **数据持久化**: 构建缓存会持久化在 Docker Volume 中
4. **同时运行**: 不要同时启动生产模式和开发模式（端口冲突）

## 📝 最佳实践

1. **开发流程**: 修改代码 → 编译 → 测试 → 提交
2. **定期清理**: 定期清理构建缓存和容器
3. **备份配置**: 重要配置文件要备份
4. **版本控制**: 使用 Git 管理代码变更

---

现在您拥有了完整的开发环境，可以实时修改源码并快速测试了！🎉 