/**
 * @file simple_server.cpp
 * @brief {{ project_name }} - åŸºç¡€TCPæœåŠ¡å™¨ç¤ºä¾‹
 * 
 * å±•ç¤ºå¦‚ä½•ä½¿ç”¨NetBoxæ¡†æ¶åˆ›å»ºä¸€ä¸ªç®€å•çš„TCPæœåŠ¡å™¨
 * 
 * @author {{ author | default("NetBox Team") }}
 * @version {{ version | default("1.0.0") }}
 * @date {{ date }}
 */

#include "netbox/NetBox.h"
#include <iostream>
{% if enable_signal_handling %}
#include <signal.h>
{% endif %}
{% if enable_json %}
#include <json/json.h>
{% endif %}

using namespace NetBox;

/**
 * @brief ç®€å•çš„è¿æ¥å¤„ç†å™¨
 */
class {{ handler_class_name | default("SimpleHandler") }} : public Application::Handler {
public:
    void onConnect(std::shared_ptr<Application::Context> ctx) override {
        std::cout << "ğŸ”— æ–°è¿æ¥: " << ctx->getRemoteAddress() << std::endl;
        
        {% if welcome_message %}
        ctx->send("{{ welcome_message }}\n");
        {% else %}
        ctx->send("æ¬¢è¿è¿æ¥åˆ° {{ project_name }} æœåŠ¡å™¨!\n");
        {% endif %}
        
        {% if enable_metrics %}
        // æ›´æ–°è¿æ¥è®¡æ•°
        m_connectionCount++;
        std::cout << "ğŸ“Š å½“å‰è¿æ¥æ•°: " << m_connectionCount << std::endl;
        {% endif %}
    }
    
    void onData(std::shared_ptr<Application::Context> ctx, const std::vector<uint8_t>& data) override {
        std::string message(data.begin(), data.end());
        std::cout << "ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: " << message << std::endl;
        
        {% if echo_mode %}
        // å›æ˜¾æ¨¡å¼
        ctx->send("Echo: " + message);
        {% else %}
        // è‡ªå®šä¹‰å“åº”
        processMessage(ctx, message);
        {% endif %}
    }
    
    void onDisconnect(std::shared_ptr<Application::Context> ctx) override {
        std::cout << "âŒ è¿æ¥æ–­å¼€: " << ctx->getRemoteAddress() << std::endl;
        
        {% if enable_metrics %}
        m_connectionCount--;
        std::cout << "ğŸ“Š å½“å‰è¿æ¥æ•°: " << m_connectionCount << std::endl;
        {% endif %}
    }
    
    void onError(std::shared_ptr<Application::Context> ctx, const std::string& error) override {
        std::cout << "âš ï¸  è¿æ¥é”™è¯¯: " << error << std::endl;
    }

private:
    {% if enable_metrics %}
    std::atomic<int> m_connectionCount{0};
    {% endif %}
    
    {% if not echo_mode %}
    void processMessage(std::shared_ptr<Application::Context> ctx, const std::string& message) {
        // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
        if (message.find("ping") != std::string::npos) {
            ctx->send("pong\n");
        } else if (message.find("time") != std::string::npos) {
            auto now = std::time(nullptr);
            ctx->send("å½“å‰æ—¶é—´: " + std::string(std::ctime(&now)));
        } else if (message.find("help") != std::string::npos) {
            ctx->send("å¯ç”¨å‘½ä»¤: ping, time, help, quit\n");
        } else if (message.find("quit") != std::string::npos) {
            ctx->send("å†è§!\n");
            ctx->close();
        } else {
            ctx->send("æœªçŸ¥å‘½ä»¤: " + message + "è¾“å…¥ 'help' æŸ¥çœ‹å¸®åŠ©\n");
        }
    }
    {% endif %}
};

/**
 * @brief ç®€å•çš„åº”ç”¨ç¨‹åºç±»
 */
class {{ app_class_name | default("SimpleApplication") }} : public Application::Application {
private:
    std::shared_ptr<Application::Handler> m_handler;
    
public:
    {{ app_class_name | default("SimpleApplication") }}() : Application("{{ project_name }}") {
        m_handler = std::make_shared<{{ handler_class_name | default("SimpleHandler") }}>();
    }
    
    bool initialize() override {
        std::cout << "ğŸ”§ åˆå§‹åŒ– {{ project_name }} æœåŠ¡å™¨..." << std::endl;
        
        {% if config_file %}
        // åŠ è½½é…ç½®æ–‡ä»¶
        if (!loadConfig("{{ config_file }}")) {
            std::cout << "âš ï¸  é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®" << std::endl;
        }
        {% endif %}
        
        {% if enable_logging %}
        // è®¾ç½®æ—¥å¿—
        setupLogging();
        {% endif %}
        
        return true;
    }
    
    bool start() override {
        std::cout << "ğŸš€ å¯åŠ¨ {{ project_name }} æœåŠ¡å™¨..." << std::endl;
        // è¿™é‡Œä¼šè¿æ¥åˆ°NetBoxçš„ç½‘ç»œå±‚
        return true;
    }
    
    void stop() override {
        std::cout << "ğŸ›‘ åœæ­¢ {{ project_name }} æœåŠ¡å™¨..." << std::endl;
    }
    
    void cleanup() override {
        std::cout << "ğŸ§¹ æ¸…ç† {{ project_name }} æœåŠ¡å™¨..." << std::endl;
    }
    
    void setHandler(std::shared_ptr<Application::Handler> handler) override {
        m_handler = handler;
    }
    
    std::shared_ptr<Application::Handler> getHandler() const override {
        return m_handler;
    }

private:
    {% if config_file %}
    bool loadConfig(const std::string& filename) {
        // é…ç½®åŠ è½½é€»è¾‘
        return true;
    }
    {% endif %}
    
    {% if enable_logging %}
    void setupLogging() {
        // æ—¥å¿—è®¾ç½®é€»è¾‘
        std::cout << "ğŸ“ æ—¥å¿—ç³»ç»Ÿå·²å¯ç”¨" << std::endl;
    }
    {% endif %}
};

{% if enable_signal_handling %}
// å…¨å±€åº”ç”¨å®ä¾‹
std::unique_ptr<{{ app_class_name | default("SimpleApplication") }}> g_app;

void signalHandler(int signal) {
    std::cout << "\nğŸ›‘ æ¥æ”¶åˆ°åœæ­¢ä¿¡å· (" << signal << ")ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨..." << std::endl;
    if (g_app) {
        g_app->stop();
    }
}
{% endif %}

int main() {
    std::cout << "ğŸŒŸ å¯åŠ¨ {{ project_name }} åŸºç¡€ç¤ºä¾‹" << std::endl;
    std::cout << "åŸºäº NetBox è·¨å¹³å°ç½‘ç»œæ¡†æ¶æ„å»º" << std::endl;
    std::cout << "========================================" << std::endl;
    
    {% if enable_signal_handling %}
    // è®¾ç½®ä¿¡å·å¤„ç†
    signal(SIGINT, signalHandler);
    signal(SIGTERM, signalHandler);
    {% endif %}
    
    // åˆå§‹åŒ–æ¡†æ¶
    if (!NETBOX_INIT()) {
        std::cerr << "âŒ NetBoxæ¡†æ¶åˆå§‹åŒ–å¤±è´¥" << std::endl;
        return 1;
    }
    
    try {
        // åˆ›å»ºåº”ç”¨
        {% if enable_signal_handling %}
        g_app = std::make_unique<{{ app_class_name | default("SimpleApplication") }}>();
        auto& app = *g_app;
        {% else %}
        auto app = std::make_unique<{{ app_class_name | default("SimpleApplication") }}>();
        {% endif %}
        
        // åˆå§‹åŒ–å¹¶å¯åŠ¨
        {% if enable_signal_handling %}
        if (app.initialize() && app.start()) {
        {% else %}
        if (app->initialize() && app->start()) {
        {% endif %}
            std::cout << "âœ… æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ!" << std::endl;
            std::cout << "ğŸ”Œ ç›‘å¬ç«¯å£: {{ port | default(8080) }}" << std::endl;
            {% if enable_telnet_test %}
            std::cout << "ğŸ’¡ æµ‹è¯•å‘½ä»¤: telnet localhost {{ port | default(8080) }}" << std::endl;
            {% endif %}
            std::cout << "========================================" << std::endl;
            std::cout << "æŒ‰ Enter é”®åœæ­¢æœåŠ¡å™¨..." << std::endl;
            
            std::cin.get();
            
            {% if enable_signal_handling %}
            app.stop();
            {% else %}
            app->stop();
            {% endif %}
        }
        
        {% if enable_signal_handling %}
        app.cleanup();
        {% else %}
        app->cleanup();
        {% endif %}
        
    } catch (const std::exception& e) {
        std::cerr << "âŒ æœåŠ¡å™¨å¼‚å¸¸: " << e.what() << std::endl;
    }
    
    // æ¸…ç†æ¡†æ¶
    NETBOX_CLEANUP();
    
    std::cout << "ğŸ‘‹ {{ project_name }} å·²å®‰å…¨å…³é—­" << std::endl;
    return 0;
}
