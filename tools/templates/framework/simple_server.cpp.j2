/**
 * @file simple_server.cpp
 * @brief {{ project_name }} - 基础TCP服务器示例
 * 
 * 展示如何使用NetBox框架创建一个简单的TCP服务器
 * 
 * @author {{ author | default("NetBox Team") }}
 * @version {{ version | default("1.0.0") }}
 * @date {{ date }}
 */

#include "netbox/NetBox.h"
#include <iostream>
{% if enable_signal_handling %}
#include <signal.h>
{% endif %}
{% if enable_json %}
#include <json/json.h>
{% endif %}

using namespace NetBox;

/**
 * @brief 简单的连接处理器
 */
class {{ handler_class_name | default("SimpleHandler") }} : public Application::Handler {
public:
    void onConnect(std::shared_ptr<Application::Context> ctx) override {
        std::cout << "🔗 新连接: " << ctx->getRemoteAddress() << std::endl;
        
        {% if welcome_message %}
        ctx->send("{{ welcome_message }}\n");
        {% else %}
        ctx->send("欢迎连接到 {{ project_name }} 服务器!\n");
        {% endif %}
        
        {% if enable_metrics %}
        // 更新连接计数
        m_connectionCount++;
        std::cout << "📊 当前连接数: " << m_connectionCount << std::endl;
        {% endif %}
    }
    
    void onData(std::shared_ptr<Application::Context> ctx, const std::vector<uint8_t>& data) override {
        std::string message(data.begin(), data.end());
        std::cout << "📨 收到消息: " << message << std::endl;
        
        {% if echo_mode %}
        // 回显模式
        ctx->send("Echo: " + message);
        {% else %}
        // 自定义响应
        processMessage(ctx, message);
        {% endif %}
    }
    
    void onDisconnect(std::shared_ptr<Application::Context> ctx) override {
        std::cout << "❌ 连接断开: " << ctx->getRemoteAddress() << std::endl;
        
        {% if enable_metrics %}
        m_connectionCount--;
        std::cout << "📊 当前连接数: " << m_connectionCount << std::endl;
        {% endif %}
    }
    
    void onError(std::shared_ptr<Application::Context> ctx, const std::string& error) override {
        std::cout << "⚠️  连接错误: " << error << std::endl;
    }

private:
    {% if enable_metrics %}
    std::atomic<int> m_connectionCount{0};
    {% endif %}
    
    {% if not echo_mode %}
    void processMessage(std::shared_ptr<Application::Context> ctx, const std::string& message) {
        // 处理不同类型的消息
        if (message.find("ping") != std::string::npos) {
            ctx->send("pong\n");
        } else if (message.find("time") != std::string::npos) {
            auto now = std::time(nullptr);
            ctx->send("当前时间: " + std::string(std::ctime(&now)));
        } else if (message.find("help") != std::string::npos) {
            ctx->send("可用命令: ping, time, help, quit\n");
        } else if (message.find("quit") != std::string::npos) {
            ctx->send("再见!\n");
            ctx->close();
        } else {
            ctx->send("未知命令: " + message + "输入 'help' 查看帮助\n");
        }
    }
    {% endif %}
};

/**
 * @brief 简单的应用程序类
 */
class {{ app_class_name | default("SimpleApplication") }} : public Application::Application {
private:
    std::shared_ptr<Application::Handler> m_handler;
    
public:
    {{ app_class_name | default("SimpleApplication") }}() : Application("{{ project_name }}") {
        m_handler = std::make_shared<{{ handler_class_name | default("SimpleHandler") }}>();
    }
    
    bool initialize() override {
        std::cout << "🔧 初始化 {{ project_name }} 服务器..." << std::endl;
        
        {% if config_file %}
        // 加载配置文件
        if (!loadConfig("{{ config_file }}")) {
            std::cout << "⚠️  配置文件加载失败，使用默认配置" << std::endl;
        }
        {% endif %}
        
        {% if enable_logging %}
        // 设置日志
        setupLogging();
        {% endif %}
        
        return true;
    }
    
    bool start() override {
        std::cout << "🚀 启动 {{ project_name }} 服务器..." << std::endl;
        // 这里会连接到NetBox的网络层
        return true;
    }
    
    void stop() override {
        std::cout << "🛑 停止 {{ project_name }} 服务器..." << std::endl;
    }
    
    void cleanup() override {
        std::cout << "🧹 清理 {{ project_name }} 服务器..." << std::endl;
    }
    
    void setHandler(std::shared_ptr<Application::Handler> handler) override {
        m_handler = handler;
    }
    
    std::shared_ptr<Application::Handler> getHandler() const override {
        return m_handler;
    }

private:
    {% if config_file %}
    bool loadConfig(const std::string& filename) {
        // 配置加载逻辑
        return true;
    }
    {% endif %}
    
    {% if enable_logging %}
    void setupLogging() {
        // 日志设置逻辑
        std::cout << "📝 日志系统已启用" << std::endl;
    }
    {% endif %}
};

{% if enable_signal_handling %}
// 全局应用实例
std::unique_ptr<{{ app_class_name | default("SimpleApplication") }}> g_app;

void signalHandler(int signal) {
    std::cout << "\n🛑 接收到停止信号 (" << signal << ")，正在关闭服务器..." << std::endl;
    if (g_app) {
        g_app->stop();
    }
}
{% endif %}

int main() {
    std::cout << "🌟 启动 {{ project_name }} 基础示例" << std::endl;
    std::cout << "基于 NetBox 跨平台网络框架构建" << std::endl;
    std::cout << "========================================" << std::endl;
    
    {% if enable_signal_handling %}
    // 设置信号处理
    signal(SIGINT, signalHandler);
    signal(SIGTERM, signalHandler);
    {% endif %}
    
    // 初始化框架
    if (!NETBOX_INIT()) {
        std::cerr << "❌ NetBox框架初始化失败" << std::endl;
        return 1;
    }
    
    try {
        // 创建应用
        {% if enable_signal_handling %}
        g_app = std::make_unique<{{ app_class_name | default("SimpleApplication") }}>();
        auto& app = *g_app;
        {% else %}
        auto app = std::make_unique<{{ app_class_name | default("SimpleApplication") }}>();
        {% endif %}
        
        // 初始化并启动
        {% if enable_signal_handling %}
        if (app.initialize() && app.start()) {
        {% else %}
        if (app->initialize() && app->start()) {
        {% endif %}
            std::cout << "✅ 服务器启动成功!" << std::endl;
            std::cout << "🔌 监听端口: {{ port | default(8080) }}" << std::endl;
            {% if enable_telnet_test %}
            std::cout << "💡 测试命令: telnet localhost {{ port | default(8080) }}" << std::endl;
            {% endif %}
            std::cout << "========================================" << std::endl;
            std::cout << "按 Enter 键停止服务器..." << std::endl;
            
            std::cin.get();
            
            {% if enable_signal_handling %}
            app.stop();
            {% else %}
            app->stop();
            {% endif %}
        }
        
        {% if enable_signal_handling %}
        app.cleanup();
        {% else %}
        app->cleanup();
        {% endif %}
        
    } catch (const std::exception& e) {
        std::cerr << "❌ 服务器异常: " << e.what() << std::endl;
    }
    
    // 清理框架
    NETBOX_CLEANUP();
    
    std::cout << "👋 {{ project_name }} 已安全关闭" << std::endl;
    return 0;
}
