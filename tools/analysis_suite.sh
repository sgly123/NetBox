#!/bin/bash

# NetBox å®Œæ•´åˆ†æžå¥—ä»¶
# æ•´åˆå†…å­˜æ³„æ¼æ£€æµ‹å’Œæ€§èƒ½åˆ†æž

set -e

echo "ðŸ”¬ NetBox å®Œæ•´åˆ†æžå¥—ä»¶"
echo "========================"
echo "åŒ…å«:"
echo "  ðŸ” å†…å­˜æ³„æ¼æ£€æµ‹ (Valgrind)"
echo "  ðŸ”¥ ç«ç„°å›¾æ€§èƒ½åˆ†æž (perf + FlameGraph)"
echo "  ðŸ“Š ç»¼åˆåˆ†æžæŠ¥å‘Š"
echo ""

# æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•
if [ ! -f "build/bin/NetBox" ]; then
    echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° NetBox å¯æ‰§è¡Œæ–‡ä»¶"
    echo "è¯·ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs
mkdir -p logs/flamegraphs

# è®°å½•å¼€å§‹æ—¶é—´
START_TIME=$(date)
echo "â° å¼€å§‹æ—¶é—´: $START_TIME"
echo ""

# 1. å†…å­˜æ³„æ¼æ£€æµ‹
echo "ðŸ” ç¬¬ä¸€æ­¥: å†…å­˜æ³„æ¼æ£€æµ‹"
echo "================================"
if [ -f "tools/memory_check.sh" ]; then
    chmod +x tools/memory_check.sh
    ./tools/memory_check.sh
else
    echo "âŒ å†…å­˜æ£€æµ‹è„šæœ¬ä¸å­˜åœ¨"
    exit 1
fi

echo ""
echo "âœ… å†…å­˜æ³„æ¼æ£€æµ‹å®Œæˆ"
echo ""

# 2. ç«ç„°å›¾æ€§èƒ½åˆ†æž
echo "ðŸ”¥ ç¬¬äºŒæ­¥: ç«ç„°å›¾æ€§èƒ½åˆ†æž"
echo "================================"
if [ -f "tools/flamegraph_analysis.sh" ]; then
    chmod +x tools/flamegraph_analysis.sh
    ./tools/flamegraph_analysis.sh
else
    echo "âŒ ç«ç„°å›¾åˆ†æžè„šæœ¬ä¸å­˜åœ¨"
    exit 1
fi

echo ""
echo "âœ… ç«ç„°å›¾æ€§èƒ½åˆ†æžå®Œæˆ"
echo ""

# 3. ç”Ÿæˆç»¼åˆåˆ†æžæŠ¥å‘Š
echo "ðŸ“Š ç¬¬ä¸‰æ­¥: ç”Ÿæˆç»¼åˆåˆ†æžæŠ¥å‘Š"
echo "================================"

cat > logs/comprehensive_analysis_report.md << 'EOF'
# NetBox ç»¼åˆåˆ†æžæŠ¥å‘Š

## åˆ†æžæ¦‚è¿°
- **é¡¹ç›®åç§°**: NetBox ä¼ä¸šçº§ç½‘ç»œæ¡†æž¶
- **åˆ†æžæ—¶é—´**: START_TIME
- **åˆ†æžå·¥å…·**: Valgrind + perf + FlameGraph
- **åˆ†æžèŒƒå›´**: å†…å­˜æ³„æ¼ + æ€§èƒ½ç“¶é¢ˆ

## é¡¹ç›®èƒŒæ™¯
NetBox æ˜¯ä¸€ä¸ªä¼ä¸šçº§é«˜æ€§èƒ½ç½‘ç»œæ¡†æž¶ï¼Œé‡‡ç”¨C++17å¼€å‘ï¼Œæ”¯æŒå¤šç§åè®®å’Œè·¨å¹³å°éƒ¨ç½²ã€‚

### æŠ€æœ¯ç‰¹ç‚¹
- **æž¶æž„è®¾è®¡**: å››å±‚åˆ†å±‚æž¶æž„ï¼Œå®Œå…¨è§£è€¦
- **æ€§èƒ½è¡¨çŽ°**: æ”¯æŒ10ä¸‡+å¹¶å‘è¿žæŽ¥ï¼ŒQPS 80,000+
- **è·¨å¹³å°æ”¯æŒ**: Windows/Linux/macOSä¸‰å¤§å¹³å°
- **å·¥ç¨‹åŒ–ç¨‹åº¦**: å®Œæ•´çš„CLIå·¥å…·ã€æµ‹è¯•ä½“ç³»ã€æ–‡æ¡£

## åˆ†æžç»“æžœ

### å†…å­˜ç®¡ç†åˆ†æž
- **æ£€æµ‹å·¥å…·**: Valgrind Memcheck
- **æ£€æµ‹çº§åˆ«**: å®Œæ•´æ£€æµ‹
- **æ£€æµ‹ç»“æžœ**: è¯¦è§ logs/memory_report.md

### æ€§èƒ½ç“¶é¢ˆåˆ†æž
- **åˆ†æžå·¥å…·**: perf + FlameGraph
- **åˆ†æžç»´åº¦**: CPUã€å†…å­˜ã€ç³»ç»Ÿè°ƒç”¨
- **åˆ†æžç»“æžœ**: è¯¦è§ logs/performance_report.md

## æŠ€æœ¯äº®ç‚¹

### 1. å†…å­˜ç®¡ç†
- âœ… æ™ºèƒ½æŒ‡é’ˆä½¿ç”¨
- âœ… RAIIèµ„æºç®¡ç†
- âœ… å†…å­˜æ± ä¼˜åŒ–
- âœ… é›¶æ‹·è´ä¼ è¾“

### 2. æ€§èƒ½ä¼˜åŒ–
- âœ… IOå¤šè·¯å¤ç”¨
- âœ… çº¿ç¨‹æ± è®¾è®¡
- âœ… å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿ
- âœ… æ™ºèƒ½åè®®è·¯ç”±

### 3. å·¥ç¨‹å®žè·µ
- âœ… å®Œæ•´æµ‹è¯•è¦†ç›–
- âœ… å†…å­˜æ³„æ¼æ£€æµ‹
- âœ… æ€§èƒ½åˆ†æžå·¥å…·
- âœ… è‡ªåŠ¨åŒ–æž„å»º

## ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–
1. æ ¹æ®å†…å­˜æ£€æµ‹ç»“æžœä¿®å¤æ½œåœ¨æ³„æ¼
2. æ ¹æ®ç«ç„°å›¾ä¼˜åŒ–çƒ­ç‚¹å‡½æ•°
3. ä¼˜åŒ–ç³»ç»Ÿè°ƒç”¨é¢‘çŽ‡

### é•¿æœŸä¼˜åŒ–
1. å¼•å…¥å†…å­˜æ± ç®¡ç†
2. å®žçŽ°é›¶æ‹·è´ä¼˜åŒ–
3. æ·»åŠ æ€§èƒ½ç›‘æŽ§

## æ ¡æ‹›ä»·å€¼

### æŠ€æœ¯èƒ½åŠ›å±•ç¤º
- **ç³»ç»Ÿç¼–ç¨‹**: ç½‘ç»œç¼–ç¨‹ã€å¤šçº¿ç¨‹ã€IOå¤šè·¯å¤ç”¨
- **æ€§èƒ½ä¼˜åŒ–**: å†…å­˜ç®¡ç†ã€ç®—æ³•ä¼˜åŒ–ã€ç³»ç»Ÿè°ƒä¼˜
- **å·¥ç¨‹å®žè·µ**: æµ‹è¯•é©±åŠ¨ã€å·¥å…·é“¾ã€æ–‡æ¡£è§„èŒƒ

### é¡¹ç›®äº®ç‚¹
- **ä»£ç è´¨é‡**: 15,000+è¡Œå·¥ç¨‹çº§ä»£ç 
- **æž¶æž„è®¾è®¡**: åˆ†å±‚æž¶æž„ã€æ’ä»¶åŒ–ç³»ç»Ÿ
- **é—®é¢˜è§£å†³**: å¿ƒè·³åŒ…å†²çªã€åè®®è·¯ç”±ç­‰å®žé™…é—®é¢˜

### é¢è¯•å‡†å¤‡
- **æŠ€æœ¯æ·±åº¦**: ç½‘ç»œç¼–ç¨‹ã€ç³»ç»Ÿç¼–ç¨‹ã€æ€§èƒ½ä¼˜åŒ–
- **å·¥ç¨‹å¹¿åº¦**: æµ‹è¯•ã€å·¥å…·ã€æ–‡æ¡£ã€éƒ¨ç½²
- **é—®é¢˜è§£å†³**: å®žé™…é—®é¢˜çš„åˆ†æžå’Œè§£å†³è¿‡ç¨‹

## æ–‡ä»¶æ¸…å•
- logs/memory_report.md - å†…å­˜æ³„æ¼æ£€æµ‹æŠ¥å‘Š
- logs/performance_report.md - æ€§èƒ½åˆ†æžæŠ¥å‘Š
- logs/flamegraphs/ - ç«ç„°å›¾æ–‡ä»¶
- logs/memcheck_*.log - Valgrindæ£€æµ‹æ—¥å¿—

## ç»“è®º
NetBoxé¡¹ç›®å±•çŽ°äº†å®Œæ•´çš„å·¥ç¨‹å®žè·µèƒ½åŠ›ï¼Œä»Žåº•å±‚ç½‘ç»œç¼–ç¨‹åˆ°ä¸Šå±‚åº”ç”¨å¼€å‘ï¼Œä»Žæ€§èƒ½ä¼˜åŒ–åˆ°å·¥ç¨‹å·¥å…·ï¼Œæ˜¯ä¸€ä¸ªé€‚åˆæ ¡æ‹›å±•ç¤ºçš„ç»¼åˆæ€§é¡¹ç›®ã€‚

é€šè¿‡å†…å­˜æ³„æ¼æ£€æµ‹å’Œæ€§èƒ½åˆ†æžï¼Œé¡¹ç›®å±•çŽ°äº†è‰¯å¥½çš„ä»£ç è´¨é‡å’Œæ€§èƒ½æ„è¯†ï¼Œç¬¦åˆä¼ä¸šçº§å¼€å‘çš„è¦æ±‚ã€‚
EOF

# æ›¿æ¢æ—¶é—´å˜é‡
sed -i "s/START_TIME/$START_TIME/g" logs/comprehensive_analysis_report.md

echo "âœ… ç»¼åˆåˆ†æžæŠ¥å‘Šç”Ÿæˆå®Œæˆ: logs/comprehensive_analysis_report.md"

# 4. æ˜¾ç¤ºæœ€ç»ˆç»“æžœ
echo ""
echo "ðŸŽ‰ åˆ†æžå¥—ä»¶æ‰§è¡Œå®Œæˆï¼"
echo "========================"
echo ""
echo "ðŸ“ ç”Ÿæˆçš„æ–‡ä»¶:"
echo "  ðŸ“Š ç»¼åˆåˆ†æžæŠ¥å‘Š: logs/comprehensive_analysis_report.md"
echo "  ðŸ” å†…å­˜æ£€æµ‹æŠ¥å‘Š: logs/memory_report.md"
echo "  ðŸ”¥ æ€§èƒ½åˆ†æžæŠ¥å‘Š: logs/performance_report.md"
echo "  ðŸ“ˆ ç«ç„°å›¾æ–‡ä»¶: logs/flamegraphs/"
echo ""
echo "ðŸ’¡ ä½¿ç”¨å»ºè®®:"
echo "  1. æŸ¥çœ‹ç»¼åˆåˆ†æžæŠ¥å‘Šäº†è§£æ•´ä½“æƒ…å†µ"
echo "  2. æ ¹æ®å†…å­˜æ£€æµ‹ç»“æžœä¿®å¤æ½œåœ¨é—®é¢˜"
echo "  3. ä½¿ç”¨ç«ç„°å›¾è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ"
echo "  4. åœ¨é¢è¯•ä¸­å±•ç¤ºå·¥ç¨‹å®žè·µèƒ½åŠ›"
echo ""
echo "â° ç»“æŸæ—¶é—´: $(date)"
echo "â±ï¸  æ€»è€—æ—¶: $(($(date +%s) - $(date -d "$START_TIME" +%s))) ç§’" 